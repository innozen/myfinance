<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ìš” ì§€ìˆ˜ & í™˜ìœ¨ ë“±ë½ë¥ </title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
      color: #222;
      padding-top: 80px;
    }
    
    /* ìƒë‹¨ í—¤ë” */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      border-bottom: 1px solid #e9ecef;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      z-index: 1000;
      padding: 16px;
    }
    
    .header-content {
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-info {
      flex: 1;
    }
    
    .header-title {
      font-size: 1.2em;
      font-weight: 700;
      color: #222;
      margin-bottom: 2px;
    }
    
    .header-update {
      font-size: 0.8em;
      color: #666;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .update-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #28a745;
      animation: pulse 2s infinite;
    }
    
    .update-dot.loading {
      background: #ffc107;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .refresh-btn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,123,255,0.2);
    }
    
    .refresh-btn:hover {
      background: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }
    
    .refresh-btn:active {
      transform: translateY(0);
    }
    
    .refresh-btn.loading {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    .refresh-icon {
      font-size: 1em;
      transition: transform 0.3s ease;
    }
    
    .refresh-btn.loading .refresh-icon {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    .item {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 16px;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.6s ease forwards;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    /* ìƒìŠ¹/í•˜ë½ ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ */
    .item.trend-up {
      background: linear-gradient(135deg, #fff 0%, #fff8f8 100%);
      border-left: 4px solid #d32f2f;
    }
    .item.trend-down {
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      border-left: 4px solid #1976d2;
    }
    .item.trend-neutral {
      background: linear-gradient(135deg, #fff 0%, #fafafa 100%);
      border-left: 4px solid #666;
    }
    
    /* í˜¸ë²„ íš¨ê³¼ */
    .item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    
    /* í˜ì´ë“œì¸ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ì• ë‹ˆë©”ì´ì…˜ ì§€ì—° */
    .item:nth-child(1) { animation-delay: 0.1s; }
    .item:nth-child(2) { animation-delay: 0.2s; }
    .item:nth-child(3) { animation-delay: 0.3s; }
    .item:nth-child(4) { animation-delay: 0.4s; }
    .item:nth-child(5) { animation-delay: 0.5s; }
    .item:nth-child(6) { animation-delay: 0.6s; }
    
    .item-title {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .item-value {
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 4px;
      transition: all 0.3s ease;
    }
    
    /* ìˆ«ì ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜ */
    .item-value.updating {
      animation: pulse 0.6s ease;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .item-change {
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    /* ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
      height: 20px;
      margin-bottom: 8px;
    }
    
    .skeleton.title {
      width: 60%;
      height: 16px;
    }
    
    .skeleton.value {
      width: 80%;
      height: 24px;
    }
    
    .skeleton.change {
      width: 70%;
      height: 18px;
    }
    
    @keyframes loading {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .item-history {
      font-size: 0.85em;
      color: #666;
      margin-top: 8px;
      line-height: 1.4;
    }
    .history-cards {
      display: flex;
      gap: 8px;
      padding: 12px 0;
      margin-top: 8px;
      width: 100%;
    }
    .history-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 14px 8px;
      flex: 1 1 25%;
      width: 25%;
      text-align: center;
      border: 1px solid #e9ecef;
      min-width: 85px;
      max-width: 25%;
      box-sizing: border-box;
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
    }
    
    /* íˆìŠ¤í† ë¦¬ ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ ì§€ì—° */
    .history-card:nth-child(1) { animation-delay: 0.1s; }
    .history-card:nth-child(2) { animation-delay: 0.2s; }
    .history-card:nth-child(3) { animation-delay: 0.3s; }
    .history-card:nth-child(4) { animation-delay: 0.4s; }
    
    /* íˆìŠ¤í† ë¦¬ ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ */
    .history-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* ìƒìŠ¹/í•˜ë½ ì¹´ë“œ ë°°ê²½ */
    .history-card.card-up {
      background: linear-gradient(135deg, #fff5f5 0%, #ffebee 100%);
      border-color: #ffcdd2;
    }
    .history-card.card-down {
      background: linear-gradient(135deg, #f3f8ff 0%, #e8f4fd 100%);
      border-color: #bbdefb;
    }
    
    .history-date {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 6px;
      white-space: nowrap;
    }
    .history-value {
      font-size: 1em;
      font-weight: 600;
      margin-bottom: 6px;
      line-height: 1.1;
      white-space: nowrap;
    }
    
    /* ê¸´ ìˆ«ìë¥¼ ìœ„í•œ ì‘ì€ í°íŠ¸ í´ë˜ìŠ¤ - ì œê±°í•˜ê³  ê· ë“±í•˜ê²Œ */
    .history-value.small-text {
      font-size: 1em;
    }
    .history-value.very-small-text {
      font-size: 1em;
    }
    
    .history-change {
      font-size: 0.85em;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      white-space: nowrap;
    }
    
    .arrow-up {
      color: #d32f2f;
      animation: bounce 0.6s ease;
    }
    .arrow-down {
      color: #1976d2;
      animation: bounce 0.6s ease;
    }
    .arrow-flat {
      color: #666;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-3px); }
      60% { transform: translateY(-2px); }
    }
    
    .history-day {
      display: inline-block;
      margin-right: 12px;
      margin-bottom: 4px;
    }
    .up { 
      color: #d32f2f;
      animation: colorPulse 0.8s ease;
    }
    .down { 
      color: #1976d2;
      animation: colorPulse 0.8s ease;
    }
    
    @keyframes colorPulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.9; }
    }
    
    .loading {
      text-align: center;
      margin-top: 40px;
      color: #888;
      animation: pulse 1.5s infinite;
    }
    
    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 480px) {
      body {
        padding-top: 70px;
      }
      
      .header {
        padding: 12px 16px;
      }
      
      .header-title {
        font-size: 1.1em;
      }
      
      .header-update {
        font-size: 0.75em;
      }
      
      .refresh-btn {
        padding: 8px 12px;
        font-size: 0.85em;
      }
      
      .container {
        padding: 12px;
      }
      .history-cards {
        gap: 6px;
      }
      .history-card {
        padding: 12px 6px;
        flex: 1 1 25%;
        width: 25%;
        max-width: 25%;
        min-width: 80px;
      }
      .history-date {
        font-size: 0.8em;
      }
      .history-value {
        font-size: 0.9em;
      }
      .history-value.small-text {
        font-size: 0.9em;
      }
      .history-value.very-small-text {
        font-size: 0.9em;
      }
      .history-change {
        font-size: 0.75em;
      }
    }
    
    /* ì•„ì£¼ ì‘ì€ í™”ë©´ (ì•„ì´í° SE ë“±) */
    @media (max-width: 375px) {
      body {
        padding-top: 65px;
      }
      
      .header {
        padding: 10px 12px;
      }
      
      .header-title {
        font-size: 1em;
      }
      
      .header-update {
        font-size: 0.7em;
      }
      
      .refresh-btn {
        padding: 6px 10px;
        font-size: 0.8em;
        gap: 4px;
      }
      
      .refresh-icon {
        font-size: 0.9em;
      }
      
      .container {
        padding: 10px;
      }
      .history-cards {
        gap: 4px;
      }
      .history-card {
        padding: 10px 4px;
        flex: 1 1 25%;
        width: 25%;
        max-width: 25%;
        min-width: 75px;
      }
      .history-date {
        font-size: 0.75em;
      }
      .history-value {
        font-size: 0.85em;
      }
      .history-value.small-text {
        font-size: 0.85em;
      }
      .history-value.very-small-text {
        font-size: 0.85em;
      }
      .history-change {
        font-size: 0.7em;
      }
    }
    
    /* í° ëª¨ë°”ì¼ í™”ë©´ */
    @media (min-width: 481px) and (max-width: 768px) {
      .history-card {
        padding: 16px 10px;
        flex: 1 1 25%;
        width: 25%;
        max-width: 25%;
        min-width: 90px;
      }
      .history-date {
        font-size: 0.95em;
      }
      .history-value {
        font-size: 1.05em;
      }
      .history-value.small-text {
        font-size: 1.05em;
      }
      .history-value.very-small-text {
        font-size: 1.05em;
      }
      .history-change {
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-info">
        <div class="header-title">ì£¼ì‹ & í™˜ìœ¨ ëŒ€ì‹œë³´ë“œ</div>
        <div class="header-update">
          <div class="update-dot" id="update-dot"></div>
          <span id="last-update">ì—…ë°ì´íŠ¸ ì¤‘...</span>
        </div>
      </div>
      <button class="refresh-btn" id="refresh-btn" onclick="handleRefresh()">
        <span class="refresh-icon" id="refresh-icon">ğŸ”„</span>
        <span id="refresh-text">ìƒˆë¡œê³ ì¹¨</span>
      </button>
    </div>
  </div>
  
  <div class="container">
    <div id="loading" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="indices" style="display:none">
      <div class="item" id="kospi">
        <div class="item-title">ì½”ìŠ¤í”¼</div>
        <div class="item-value" id="kospi-value"><div class="skeleton value"></div></div>
        <div class="item-change" id="kospi-change"><div class="skeleton change"></div></div>
        <div class="item-history" id="kospi-history"></div>
      </div>
      <div class="item" id="kosdaq">
        <div class="item-title">ì½”ìŠ¤ë‹¥</div>
        <div class="item-value" id="kosdaq-value"><div class="skeleton value"></div></div>
        <div class="item-change" id="kosdaq-change"><div class="skeleton change"></div></div>
        <div class="item-history" id="kosdaq-history"></div>
      </div>
      <div class="item" id="sp500">
        <div class="item-title">S&P 500</div>
        <div class="item-value" id="sp500-value"><div class="skeleton value"></div></div>
        <div class="item-change" id="sp500-change"><div class="skeleton change"></div></div>
        <div class="item-history" id="sp500-history"></div>
      </div>
      <div class="item" id="nasdaq100">
        <div class="item-title">ë‚˜ìŠ¤ë‹¥ 100</div>
        <div class="item-value" id="nasdaq100-value"><div class="skeleton value"></div></div>
        <div class="item-change" id="nasdaq100-change"><div class="skeleton change"></div></div>
        <div class="item-history" id="nasdaq100-history"></div>
      </div>
      <div class="item" id="usdkrw">
        <div class="item-title">ë‹¬ëŸ¬ í™˜ìœ¨ (USD/KRW)</div>
        <div class="item-value" id="usdkrw-value"><div class="skeleton value"></div></div>
        <div class="item-change" id="usdkrw-change"><div class="skeleton change"></div></div>
        <div class="item-history" id="usdkrw-history"></div>
      </div>
      <div class="item" id="jpykrw">
        <div class="item-title">ì—”í™” í™˜ìœ¨ (JPY/KRW)</div>
        <div class="item-value" id="jpykrw-value"><div class="skeleton value"></div></div>
        <div class="item-change" id="jpykrw-change"><div class="skeleton change"></div></div>
        <div class="item-history" id="jpykrw-history"></div>
      </div>
    </div>
  </div>
  <script>
    const ALPHA_VANTAGE_KEY = '600ER7S7AEIFP1IX';

    // í•­ìƒ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ì²˜ë¦¬ (ì•ˆì •ì„± ê·¹ëŒ€í™”)
    const USE_FRONTEND_FETCH = true; // ë°±ì—”ë“œ ëŒ€ì‹  í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš©
    
    // ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸ (Netlify Functions)
    const API_ENDPOINT = '/.netlify/functions/stocks';

    // Yahoo Finance Symbol Map
    const YAHOO_SYMBOLS = {
      'kospi': '^KS11', // ì½”ìŠ¤í”¼
      'kosdaq': '^KQ11', // ì½”ìŠ¤ë‹¥
      'sp500': '^GSPC', // S&P 500
      'nasdaq100': '^NDX', // ë‚˜ìŠ¤ë‹¥ 100
      'usdkrw': 'USDKRW=X', // ë‹¬ëŸ¬/ì› í™˜ìœ¨
      'jpykrw': 'JPYKRW=X'  // ì—”/ì› í™˜ìœ¨
    };

    // Yahoo Financeì—ì„œ ì§ì ‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì•ˆì •ì„± ê·¹ëŒ€í™”)
    async function fetchYahooData(symbol) {
      const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=5d`;
      
      // ì—¬ëŸ¬ í”„ë¡ì‹œ ì˜µì…˜ ì‹œë„ (ìˆœì„œëŒ€ë¡œ)
      const proxies = [
        `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
        `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`,
        `https://cors-anywhere.herokuapp.com/${targetUrl}`
      ];
      
      // ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
      for (let attempt = 1; attempt <= 3; attempt++) {
        for (const proxyUrl of proxies) {
          try {
            console.log(`Trying ${symbol} via ${proxyUrl.split('?')[0]} (attempt ${attempt})`);
            const response = await fetch(proxyUrl, { timeout: 15000 });
            
            if (!response.ok) {
              console.log(`Proxy failed: ${response.status}`);
              continue;
            }
            
            let parsed;
            if (proxyUrl.includes('allorigins.win')) {
              const data = await response.json();
              parsed = JSON.parse(data.contents);
            } else {
              parsed = await response.json();
            }
            
            const result = parsed.chart.result[0];
            const close = result.indicators.quote[0].close;
            const timestamps = result.timestamp;
            
            // null ê°’ í•„í„°ë§
            const validData = [];
            for (let i = 0; i < timestamps.length && i < close.length; i++) {
              if (timestamps[i] && close[i] !== null && close[i] !== undefined) {
                validData.push({
                  timestamp: timestamps[i],
                  close: close[i]
                });
              }
            }
            
            if (validData.length < 2) {
              console.log(`Insufficient data for ${symbol}: ${validData.length} points`);
              continue;
            }
            
            // ìµœê·¼ 2ì¼ ë°ì´í„°ë¡œ í˜„ì¬ê°’ê³¼ ë³€í™” ê³„ì‚°
            let prev = validData[validData.length - 2].close;
            let curr = validData[validData.length - 1].close;
            
            // JPY/KRWì˜ ê²½ìš° 100ì„ ê³±í•´ì„œ 100ì—” ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜
            if (symbol === 'JPYKRW=X') {
              prev = prev * 100;
              curr = curr * 100;
            }
            
            const change = curr - prev;
            const percent = (change / prev) * 100;
            
            // íˆìŠ¤í† ë¦¬ ë°ì´í„° ìƒì„± (ì˜¤ëŠ˜ ì œì™¸, ìµœê·¼ 4ì¼, ë“±ë½/í™”ì‚´í‘œ ì™„ì „ ì •ìƒ)
            const history = [];
            for (let i = validData.length - 5; i < validData.length - 1; i++) {
              if (i < 1) continue; // prevValueê°€ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€
              const date = new Date(validData[i].timestamp * 1000);
              let value = validData[i].close;
              let prevValue = validData[i-1].close;
              if (symbol === 'JPYKRW=X') {
                value = value * 100;
                prevValue = prevValue * 100;
              }
              const dayChange = value - prevValue;
              history.push({
                date: `${date.getMonth() + 1}/${date.getDate()}`,
                value: value.toLocaleString(undefined, {maximumFractionDigits: 2}),
                change: dayChange.toFixed(2),
                isUp: dayChange >= 0
              });
            }
            
            console.log(`âœ… Success for ${symbol}: ${curr.toLocaleString()}`);
            return {
              main: {
                symbol,
                value: curr.toLocaleString(undefined, {maximumFractionDigits: 2}),
                change: `${change >= 0 ? '+' : ''}${change.toFixed(2)}`,
                percent: `${change >= 0 ? '+' : ''}${percent.toFixed(2)}%`,
                up: change >= 0
              },
              history: history
            };
          } catch (error) {
            console.log(`Error with ${proxyUrl.split('?')[0]}: ${error.message}`);
            continue;
          }
        }
        
        // ì¬ì‹œë„ ì „ ëŒ€ê¸°
        if (attempt < 3) {
          console.log(`All proxies failed for ${symbol}, retrying in 1 second...`);
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
      
      console.log(`âŒ All attempts failed for ${symbol}`);
      return null;
    }

    // ë¡œì»¬ìš© ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ (ìµœì í™”ëœ ìˆœì°¨ ë¡œë”©)
    async function fetchAllStockDataLocal() {
      try {
        const data = {};
        const symbols = [
          { key: 'kospi', symbol: YAHOO_SYMBOLS.kospi, name: 'KOSPI' },
          { key: 'kosdaq', symbol: YAHOO_SYMBOLS.kosdaq, name: 'KOSDAQ' },
          { key: 'sp500', symbol: YAHOO_SYMBOLS.sp500, name: 'S&P 500' },
          { key: 'nasdaq100', symbol: YAHOO_SYMBOLS.nasdaq100, name: 'NASDAQ 100' },
          { key: 'usdkrw', symbol: YAHOO_SYMBOLS.usdkrw, name: 'USD/KRW' },
          { key: 'jpykrw', symbol: YAHOO_SYMBOLS.jpykrw, name: 'JPY/KRW' }
        ];
        
        // ìˆœì°¨ì ìœ¼ë¡œ ë°ì´í„° ë¡œë”© (ì ì§„ì  í‘œì‹œ)
        for (let i = 0; i < symbols.length; i++) {
          const { key, symbol, name } = symbols[i];
          
          // ì§„í–‰ë¥  í‘œì‹œ
          updateLoadingProgress(i + 1, symbols.length, name);
          
          // ê°œë³„ ë°ì´í„° ë¡œë”©
          const result = await fetchYahooData(symbol);
          
          if (result) {
            data[key] = result;
            // ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ
            renderSection(key, result.main, result.history);
            console.log(`âœ… ${name} ë¡œë”© ì™„ë£Œ`);
          } else {
            console.log(`âŒ ${name} ë¡œë”© ì‹¤íŒ¨`);
            renderSection(key, null, null);
          }
          
          // í”„ë¡ì‹œ ì„œë²„ ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸°
          if (i < symbols.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 200));
          }
        }
        
        return {
          timestamp: new Date().toISOString(),
          data: data,
          cached: false
        };
      } catch (error) {
        console.error('Error fetching local data:', error);
        throw error;
      }
    }

    // ë°±ì—”ë“œ APIì—ì„œ ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchAllStockData(forceRefresh = false) {
      if (USE_FRONTEND_FETCH) {
        return await fetchAllStockDataLocal();
      }
      
      try {
        const url = forceRefresh ? `${API_ENDPOINT}?refresh=true` : API_ENDPOINT;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        return result;
      } catch (error) {
        console.error('Error fetching from backend:', error);
        throw error;
      }
    }

    // ë°±ì—”ë“œ ë°ì´í„°ë¥¼ í”„ë¡ íŠ¸ì—”ë“œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    function transformBackendData(backendData) {
      const sections = {};
      
      if (backendData && backendData.data) {
        Object.keys(backendData.data).forEach(key => {
          const item = backendData.data[key];
          if (item && item.main) {
            sections[key] = {
              data: item.main,
              history: item.history || []
            };
          }
        });
      }
      
      return sections;
    }

    // ê¸°ì¡´ í•¨ìˆ˜ë“¤ ì œê±° (ë°±ì—”ë“œë¡œ ì´ë™)
    /*
    async function fetchYahooIndex(symbol) { ... }
    async function fetchHistory(symbol, isJPY = false) { ... }
    */

    function renderHistoryCards(historyData) {
      if (!historyData || historyData.length === 0) return '';
      
      const historyHtml = historyData.map((day, index) => {
        let arrow = '';
        let arrowClass = '';
        let cardClass = '';
        if (day.change > 0) {
          arrow = 'â–²';
          arrowClass = 'arrow-up';
          cardClass = 'card-up';
        } else if (day.change < 0) {
          arrow = 'â–¼';
          arrowClass = 'arrow-down';
          cardClass = 'card-down';
        } else {
          arrow = 'â”€';
          arrowClass = 'arrow-flat';
        }
        
        // ëª¨ë“  ì¹´ë“œì˜ í°íŠ¸ í¬ê¸°ë¥¼ ë™ì¼í•˜ê²Œ ìœ ì§€
        return `<div class="history-card ${cardClass}" style="animation-delay: ${0.1 + index * 0.1}s">
          <div class="history-date">${day.date}</div>
          <div class="history-value">${day.value}</div>
          <div class="history-change ${day.isUp ? 'up' : 'down'}">
            <span class="${arrowClass}">${arrow}</span>
            <span>${day.isUp ? '+' : ''}${day.change}</span>
          </div>
        </div>`;
      }).join('');
      
      return `<div style="font-size: 0.9em; margin-bottom: 4px; color: #888;">ìµœê·¼ 4ì¼</div><div class="history-cards">${historyHtml}</div>`;
    }

    // ê° ì„¹ì…˜ì„ ë…ë¦½ì ìœ¼ë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ë“¤
    function renderSection(sectionId, data, history) {
      const itemEl = document.getElementById(sectionId);
      const valueEl = document.getElementById(`${sectionId}-value`);
      const changeEl = document.getElementById(`${sectionId}-change`);
      const historyEl = document.getElementById(`${sectionId}-history`);
      
      if (data) {
        // íŠ¸ë Œë“œ í´ë˜ìŠ¤ ì ìš©
        itemEl.classList.remove('trend-up', 'trend-down', 'trend-neutral');
        if (data.up) {
          itemEl.classList.add('trend-up');
        } else if (data.change.includes('-')) {
          itemEl.classList.add('trend-down');
        } else {
          itemEl.classList.add('trend-neutral');
        }
        
        // ìˆ«ì ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜
        valueEl.classList.add('updating');
        setTimeout(() => valueEl.classList.remove('updating'), 600);
        
        valueEl.textContent = data.value;
        changeEl.innerHTML = `<span class="${data.up ? 'up' : 'down'}">${data.change} (${data.percent})</span>`;
        
        if (history) {
          historyEl.innerHTML = renderHistoryCards(history);
        }
      } else {
        itemEl.classList.add('trend-neutral');
        valueEl.textContent = '-';
        changeEl.textContent = 'ë°ì´í„° ì—†ìŒ';
      }
    }

    // í˜„ì¬ ì‹œê°„ì„ í¬ë§·íŒ…í•˜ëŠ” í•¨ìˆ˜
    function formatTime(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const seconds = date.getSeconds().toString().padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    // ë¡œë”© ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateLoadingProgress(current, total, currentName) {
      const lastUpdate = document.getElementById('last-update');
      const progress = Math.round((current / total) * 100);
      lastUpdate.textContent = `ë¡œë”© ì¤‘... ${current}/${total} (${progress}%) - ${currentName}`;
    }

    // í—¤ë” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateHeader(isLoading = false) {
      const updateDot = document.getElementById('update-dot');
      const lastUpdate = document.getElementById('last-update');
      const refreshBtn = document.getElementById('refresh-btn');
      const refreshIcon = document.getElementById('refresh-icon');
      const refreshText = document.getElementById('refresh-text');
      
      if (isLoading) {
        updateDot.classList.add('loading');
        lastUpdate.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘...';
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
        refreshText.textContent = 'ë¡œë”©ì¤‘';
      } else {
        updateDot.classList.remove('loading');
        const now = new Date();
        lastUpdate.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${formatTime(now)}`;
        refreshBtn.classList.remove('loading');
        refreshBtn.disabled = false;
        refreshText.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    function handleRefresh() {
      loadData(true); // ê°•ì œ ìƒˆë¡œê³ ì¹¨
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìºì‹œëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function getCachedData() {
      try {
        const cached = localStorage.getItem('financeData');
        if (cached) {
          const data = JSON.parse(cached);
          const cacheAge = Date.now() - new Date(data.timestamp).getTime();
          // 5ë¶„ ì´ë‚´ ìºì‹œë§Œ ì‚¬ìš©
          if (cacheAge < 5 * 60 * 1000) {
            console.log('ğŸ“¦ Using cached data');
            return data;
          }
        }
      } catch (error) {
        console.log('Cache error:', error);
      }
      return null;
    }

    // ë°ì´í„°ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìºì‹œí•˜ê¸°
    function cacheData(data) {
      try {
        localStorage.setItem('financeData', JSON.stringify(data));
        console.log('ğŸ’¾ Data cached');
      } catch (error) {
        console.log('Cache save error:', error);
      }
    }

    async function loadData(forceRefresh = false) {
      updateHeader(true);
      document.getElementById('loading').style.display = 'block';
      document.getElementById('indices').style.display = 'block';

      try {
        // ê°•ì œ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹ˆë©´ ìºì‹œ ë¨¼ì € í™•ì¸
        if (!forceRefresh) {
          const cachedData = getCachedData();
          if (cachedData) {
            console.log('ğŸš€ Loading from cache...');
            
            if (USE_FRONTEND_FETCH) {
              // í”„ë¡ íŠ¸ì—”ë“œ ìºì‹œ: ì§ì ‘ ë°ì´í„° ì‚¬ìš©
              Object.keys(cachedData.data).forEach(key => {
                const section = cachedData.data[key];
                if (section && section.main) {
                  renderSection(key, section.main, section.history);
                }
              });
            } else {
              // ë°±ì—”ë“œ ìºì‹œ: ë³€í™˜ í•„ìš”
              const sections = transformBackendData(cachedData);
              Object.keys(sections).forEach(key => {
                const section = sections[key];
                if (section && section.data) {
                  renderSection(key, section.data, section.history);
                }
              });
            }
            
            document.getElementById('loading').style.display = 'none';
            updateHeader(false);
            
            // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° ì—…ë°ì´íŠ¸
            setTimeout(() => {
              loadData(true);
            }, 1000);
            return;
          }
        }
        
        // ìƒˆë¡œìš´ ë°ì´í„° ë¡œë”©
        console.log('ğŸ”„ Loading fresh data...');
        const backendResponse = await fetchAllStockData(forceRefresh);
        console.log('Raw backend response:', backendResponse);
        
        // í”„ë¡ íŠ¸ì—”ë“œ ë¡œë”©ì˜ ê²½ìš° ì´ë¯¸ ì ì§„ì ìœ¼ë¡œ í‘œì‹œë˜ì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ë Œë”ë§ ë¶ˆí•„ìš”
        if (!USE_FRONTEND_FETCH) {
          const sections = transformBackendData(backendResponse);
          console.log('Transformed sections:', sections);
          
          // ê° ì„¹ì…˜ ë Œë”ë§
          console.log('Available sections:', Object.keys(sections));
          
          // ëª¨ë“  ì˜ˆìƒ ì„¹ì…˜ í™•ì¸
          const expectedSections = ['kospi', 'kosdaq', 'sp500', 'nasdaq100', 'usdkrw', 'jpykrw'];
          expectedSections.forEach(sectionKey => {
            if (sections[sectionKey]) {
              console.log(`âœ… Rendering ${sectionKey}:`, sections[sectionKey]);
              renderSection(sectionKey, sections[sectionKey].data, sections[sectionKey].history);
            } else {
              console.log(`âŒ Missing ${sectionKey} data`);
              // ë¹ˆ ë°ì´í„°ë¡œ ë Œë”ë§
              renderSection(sectionKey, null, []);
            }
          });
        }

        // ì„±ê³µí•œ ë°ì´í„° ìºì‹œ
        if (backendResponse && backendResponse.data) {
          cacheData(backendResponse);
        }

        document.getElementById('loading').style.display = 'none';
        updateHeader(false);
        
      } catch (error) {
        console.error('Failed to load data:', error);
        document.getElementById('loading').textContent = 'ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ì£¼ì„¸ìš”.';
        updateHeader(false);
      }
    }

    loadData();
  </script>
</body>
</html>

